<!DOCTYPE html>
<html>
<head>
    <title>IoT Farm Control</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        body { font-family: Arial; text-align: center; background: #f4f4f4; margin: 0; padding: 20px; }
        .container { max-width: 900px; margin: 0 auto; display: flex; flex-wrap: wrap; justify-content: center; gap: 20px; }
        .card { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); flex: 1 1 300px; min-width: 280px; }
        .chart-card { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); flex: 1 1 100%; max-width: 800px; margin: 20px auto; }
        .btn { padding: 10px 20px; font-size: 16px; cursor: pointer; border: none; border-radius: 5px; margin: 5px; transition: background 0.3s ease; }
        .on { background: #2ecc71; color: white; }
        .off { background: #e74c3c; color: white; }
        .auto { background: #3498db; color: white; }
        .btn:hover { opacity: 0.9; }
        h2, h3 { color: #333; }
        p { color: #555; }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

    <h2>Hệ Thống Tưới Cây IoT</h2>

    <div class="container">
        <div class="card">
            <h3>Cảm biến (Hiện tại)</h3>
            <p>Nhiệt độ: <span id="temp">--</span>°C</p>
            <p>Độ ẩm đất: <span id="soil">--</span>%</p>
            <p>Độ ẩm không khí: <span id="air_humidity">--</span>%</p>
            <p>Cập nhật: <span id="time">--</span></p>
        </div>

        <div class="card">
            <h3>Điều khiển Máy Bơm</h3>
            <p>Chế độ: <strong id="modeText">--</strong></p>
            <button class="btn auto" onclick="setMode('auto')">Tự động</button>
            <button class="btn off" onclick="setMode('manual')">Thủ công</button>
            <br><br>
            <div id="manualControl" style="display:none;">
                <button class="btn on" onclick="setPump(1)">Bật Bơm</button>
                <button class="btn off" onclick="setPump(0)">Tắt Bơm</button>
            </div>
			<button class="btn off" onclick="resetHistory()">Reset bảng cây</button>
        </div>
    </div>

    <div class="chart-card">
        <h3>Biểu đồ Lịch sử</h3>
        <canvas id="myChart"></canvas>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getDatabase, ref, onValue, set, update } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

	const firebaseConfig = {
 	 apiKey: "AIzaSyASA1sLoaNqll4mU42pl-1y6OxHsr3IWPM",
  	 authDomain: "doan-iot-24242.firebaseapp.com",
  	 databaseURL: "https://doan-iot-24242-default-rtdb.firebaseio.com",
  	 projectId: "doan-iot-24242",
  	 storageBucket: "doan-iot-24242.firebasestorage.app",
  	 messagingSenderId: "170782338545",
  	 appId: "1:170782338545:web:417c82eb4c3f4b8912e850"
	};

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // Khởi tạo biểu đồ rỗng
        const ctx = document.getElementById('myChart').getContext('2d');
        const myChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [], // Thời gian
                datasets: [
                    {
                        label: 'Nhiệt độ (°C)',
                        data: [],
                        borderColor: 'rgb(255, 99, 132)',
                        backgroundColor: 'rgba(255, 99, 132, 0.2)',
                        fill: false,
                        tension: 0.1
                    },
                    {
                        label: 'Độ ẩm đất (%)',
                        data: [],
                        borderColor: 'rgb(54, 162, 235)',
                        backgroundColor: 'rgba(54, 162, 235, 0.2)',
                        fill: false,
                        tension: 0.1
                    },
                    {
                        label: 'Độ ẩm không khí (%)',
                        data: [],
                        borderColor: 'rgb(75, 192, 192)',
                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        fill: false,
                        tension: 0.1
                    }
                ]
            },
            options: {
                responsive: true,
                scales: {
                    x: {
                        type: 'category', // Để hiển thị chuỗi thời gian
                        title: {
                            display: true,
                            text: 'Thời gian'
                        }
                    },
                    y: {
                        beginAtZero: false,
                        title: {
                            display: true,
                            text: 'Giá trị'
                        }
                    }
                }
            }
        });

        // 1. Lấy dữ liệu cảm biến thời gian thực (sensor_current)
        onValue(ref(db, 'sensor_current'), (snapshot) => {
            const data = snapshot.val();
            if (data) { // Đảm bảo có dữ liệu trước khi hiển thị
                document.getElementById('temp').innerText = data.temperature ? data.temperature.toFixed(1) : '--';
                document.getElementById('soil').innerText = data.humidity_soil ? data.humidity_soil.toFixed(0) : '--';
                document.getElementById('air_humidity').innerText = data.humidity_air ? data.humidity_air.toFixed(1) : '--';
                document.getElementById('time').innerText = data.datetime || '--';
            }
        });

        // 2. Lấy trạng thái chế độ bơm
        onValue(ref(db, 'pump/mode'), (snapshot) => {
            const mode = snapshot.val();
            document.getElementById('modeText').innerText = mode ? mode.toUpperCase() : '--';
            document.getElementById('manualControl').style.display = (mode === 'manual') ? 'block' : 'none';
        });
        
        // 3. Lấy dữ liệu lịch sử để vẽ biểu đồ (sensor_history)
        onValue(ref(db, 'sensor_history'), (snapshot) => {
            const historyData = snapshot.val();
            const labels = [];
            const temperatures = [];
            const soilHumidities = [];
            const airHumidities = [];

            if (historyData) {
                // Sắp xếp dữ liệu theo thời gian nếu cần (Firebase trả về object, không phải mảng)
                const sortedKeys = Object.keys(historyData).sort((a, b) => {
                    const timeA = historyData[a].datetime;
                    const timeB = historyData[b].datetime;
                    return new Date(timeA) - new Date(timeB);
                });

                // Lấy 50 điểm dữ liệu gần nhất để tránh lag trình duyệt
                const recentKeys = sortedKeys.slice(-50); 

                recentKeys.forEach(key => {
                    const item = historyData[key];
                    if (item && item.datetime && item.temperature !== undefined && item.humidity_soil !== undefined && item.humidity_air !== undefined) {
                        // Cắt bớt phần ngày, chỉ lấy HH:MM:SS nếu muốn gọn hơn trên biểu đồ
                        const timePart = item.datetime.split(' ')[1]; 
                        labels.push(timePart);
                        temperatures.push(parseFloat(item.temperature));
                        soilHumidities.push(parseFloat(item.humidity_soil));
                        airHumidities.push(parseFloat(item.humidity_air));
                    }
                });
            }

            // Cập nhật dữ liệu cho biểu đồ
            myChart.data.labels = labels;
            myChart.data.datasets[0].data = temperatures;
            myChart.data.datasets[1].data = soilHumidities;
            myChart.data.datasets[2].data = airHumidities;
            myChart.update(); // Cập nhật biểu đồ
        });


        // 4. Hàm gửi lệnh lên Firebase
        window.setMode = (mode) => {
            update(ref(db, 'pump'), { mode: mode });
        }

        window.setPump = (status) => {
            set(ref(db, 'pump/status'), status);
        }

		// LED trạng thái máy bơm (đồng bộ Firebase + Wokwi)
onValue(ref(db, 'pump/status'), (snapshot) => {
    const status = snapshot.val();
    const led = document.getElementById('pumpLed');

    if (status === 1) {
        led.style.background = 'limegreen';
    } else {
        led.style.background = 'red';
    }
});

// Reset lịch sử cảm biến (reset bảng cây)
window.resetHistory = () => {
    if (confirm("Reset toàn bộ dữ liệu lịch sử?")) {
        set(ref(db, 'sensor_history'), null);
    }
};
		
    </script>
</body>
</html>
